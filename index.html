<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Kewangan LDP BPG 2026</title>
    
    <!-- Enjin Visual (Mesti ada Internet) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- Skrin Loading Statik -->
    <div id="fallback-loading" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50">
        <div class="spinner mb-4"></div>
        <h2 class="text-slate-800 text-lg font-bold">Menyediakan Dashboard...</h2>
        <p class="text-slate-400 text-sm">Jika paparan ini tidak hilang, sila pastikan anda membuka fail ini menggunakan Chrome/Edge dan mempunyai internet.</p>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Cell, PieChart, Pie } = Recharts;

        // =================================================================================
        // üîß DATA LIVE DARI GOOGLE SHEETS ANDA
        // =================================================================================
        const SHEET_LINKS = {
            ANALISIS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZd2KLh_LqBhHbSkRKL0rsoESf60kgFSomuC8kwgZqkLbRvXyqWTqr2DoEzzP15BV491auFw3BdFKd/pub?gid=0&single=true&output=csv', 
            PROGRAMS: {
                'LDP-BPG-LEAD AUDITOR': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZd2KLh_LqBhHbSkRKL0rsoESf60kgFSomuC8kwgZqkLbRvXyqWTqr2DoEzzP15BV491auFw3BdFKd/pub?gid=1435925801&single=true&output=csv',
                'LDP-BPG-PEMERKASAAN COE': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZd2KLh_LqBhHbSkRKL0rsoESf60kgFSomuC8kwgZqkLbRvXyqWTqr2DoEzzP15BV491auFw3BdFKd/pub?gid=1031215483&single=true&output=csv',
                'LDP-BPG-CERTIFIED ASSESSOR': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZd2KLh_LqBhHbSkRKL0rsoESf60kgFSomuC8kwgZqkLbRvXyqWTqr2DoEzzP15BV491auFw3BdFKd/pub?gid=2077989648&single=true&output=csv'
            }
        };

        const formatCurrency = (val) => new Intl.NumberFormat('ms-MY', { style: 'currency', currency: 'MYR' }).format(val);

        const cleanNum = (str) => {
            if (!str) return 0;
            // Menghapuskan RM, koma, tanda petik, dan simbol lain
            let cleaned = str.replace(/[RM,\s%"]/g, "");
            return parseFloat(cleaned) || 0;
        };

        const robustSplit = (line) => {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
                else current += char;
            }
            result.push(current.trim());
            return result;
        };

        function App() {
            const [data, setData] = useState([]);
            const [detailData, setDetailData] = useState([]);
            const [view, setView] = useState('summary');
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [activeProgram, setActiveProgram] = useState("");

            useEffect(() => {
                // Padam skrin loading statik apabila React sudah sedia
                const loader = document.getElementById('fallback-loading');
                if (loader) loader.style.display = 'none';
                fetchSummary();
            }, []);

            const fetchSummary = async () => {
                setLoading(true);
                setError(null);
                try {
                    const response = await fetch(SHEET_LINKS.ANALISIS);
                    if (!response.ok) throw new Error("Gagal menyambung ke Google Sheets. Sila semak pautan 'Publish to Web'.");
                    const text = await response.text();
                    const lines = text.split(/\r?\n/).filter(l => l.trim());
                    
                    const parsed = [];
                    lines.forEach((line) => {
                        const row = robustSplit(line);
                        // Kenalpasti baris data berdasarkan Kod SK
                        if (row.length > 5 && row[1] && row[1].startsWith('SK')) {
                            parsed.push({
                                kod: row[1],
                                program: row[2].replace(/"/g, ''),
                                peruntukan: cleanNum(row[3]) + cleanNum(row[4]), // OS21 + OS29
                                belanja: cleanNum(row[6]) + cleanNum(row[7]), // OS21 + OS29
                            });
                        }
                    });

                    if (parsed.length === 0) throw new Error("Data tidak ditemui. Pastikan tab 'ANALISIS' mempunyai data dari baris ke-5.");
                    setData(parsed);
                } catch (err) {
                    setError(err.message);
                }
                setLoading(false);
            };

            const fetchDetail = async (progName) => {
                setLoading(true);
                setActiveProgram(progName);
                try {
                    const link = SHEET_LINKS.PROGRAMS[progName];
                    if (!link) throw new Error("Pautan program ini tidak ditemui.");
                    
                    const response = await fetch(link);
                    const text = await response.text();
                    const lines = text.split(/\r?\n/).filter(l => l.trim());
                    
                    const parsed = [];
                    lines.forEach((line) => {
                        const row = robustSplit(line);
                        // Baris data bermula dengan nombor BIL
                        if (row.length > 10 && !isNaN(parseInt(row[0]))) {
                            parsed.push({
                                bil: row[0],
                                nama: row[2].replace(/"/g, ''),
                                p_jum: cleanNum(row[5]),
                                b_jum: cleanNum(row[8]),
                                tarikh: `${row[12]} - ${row[13]}`,
                                pax: row[14],
                                lokasi: row[15]
                            });
                        }
                    });
                    setDetailData(parsed);
                    setView('detail');
                } catch (err) {
                    alert(err.message);
                }
                setLoading(false);
            };

            const totalP = data.reduce((a, b) => a + b.peruntukan, 0);
            const totalB = data.reduce((a, b) => a + b.belanja, 0);

            if (error) return (
                <div className="flex flex-col items-center justify-center h-screen p-6 text-center">
                    <div className="bg-white p-8 rounded-3xl shadow-xl border-2 border-red-100 max-w-md">
                        <div className="text-red-500 text-5xl mb-4">‚ö†Ô∏è</div>
                        <h2 className="text-xl font-bold mb-2">Ralat Data</h2>
                        <p className="text-slate-500 text-sm mb-6">{error}</p>
                        <button onClick={fetchSummary} className="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-blue-700 transition">Cuba Lagi</button>
                    </div>
                </div>
            );

            return (
                <div className="max-w-7xl mx-auto p-4 md:p-10">
                    {/* Header */}
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
                        <div>
                            <h1 className="text-2xl font-black text-slate-800 tracking-tight uppercase">Dashboard Kewangan LDP 2026</h1>
                            <p className="text-slate-400 text-xs font-bold tracking-widest uppercase">Institut Aminuddin Baki ‚Ä¢ Data Live</p>
                        </div>
                        <div className="flex gap-2 w-full md:w-auto">
                            {view === 'detail' && (
                                <button onClick={() => setView('summary')} className="flex-1 md:flex-none bg-white border border-slate-200 px-4 py-2 rounded-xl text-xs font-bold shadow-sm">&larr; Balik</button>
                            )}
                            <button onClick={fetchSummary} className="flex-1 md:flex-none bg-blue-600 text-white px-6 py-2 rounded-xl text-xs font-bold shadow-lg shadow-blue-200">üîÑ Refresh</button>
                        </div>
                    </div>

                    {view === 'summary' ? (
                        <div className="space-y-8">
                            {/* Kad Ringkasan */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div className="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                                    <p className="text-[10px] text-slate-400 font-black uppercase mb-1">Peruntukan Dipohon</p>
                                    <h2 className="text-2xl font-black text-blue-600">{formatCurrency(totalP)}</h2>
                                </div>
                                <div className="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                                    <p className="text-[10px] text-slate-400 font-black uppercase mb-1">Perbelanjaan Semasa</p>
                                    <h2 className="text-2xl font-black text-orange-500">{formatCurrency(totalB)}</h2>
                                </div>
                                <div className="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                                    <p className="text-[10px] text-slate-400 font-black uppercase mb-1">Baki Bersih</p>
                                    <h2 className="text-2xl font-black text-emerald-600">{formatCurrency(totalP - totalB)}</h2>
                                </div>
                            </div>

                            {/* Graf Bar */}
                            <div className="bg-white p-6 md:p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                                <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-8">Prestasi Kewangan Mengikut Kod</h3>
                                <div className="h-72">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={data}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                            <XAxis dataKey="kod" axisLine={false} tickLine={false} tick={{fontSize: 10, fontWeight: 700}} />
                                            <YAxis hide />
                                            <Tooltip contentStyle={{borderRadius: '16px', border: 'none', boxShadow: '0 10px 15px rgba(0,0,0,0.05)'}} />
                                            <Bar dataKey="peruntukan" name="Peruntukan" fill="#3b82f6" radius={[6, 6, 0, 0]} barSize={30} />
                                            <Bar dataKey="belanja" name="Belanja" fill="#f97316" radius={[6, 6, 0, 0]} barSize={30} />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>

                            {/* Jadual Utama */}
                            <div className="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden">
                                <div className="p-6 bg-slate-50 border-b border-slate-100">
                                    <h3 className="text-xs font-black text-slate-800 uppercase tracking-widest text-center md:text-left">Senarai Program Induk</h3>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left text-[11px]">
                                        <thead>
                                            <tr className="text-slate-400 font-black uppercase border-b bg-slate-50/50">
                                                <th className="p-5">Kod</th>
                                                <th className="p-5">Program</th>
                                                <th className="p-5 text-right">Peruntukan</th>
                                                <th className="p-5 text-right">Belanja</th>
                                                <th className="p-5 text-center">Tindakan</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-50">
                                            {data.map((item, i) => (
                                                <tr key={i} className="hover:bg-slate-50/80 transition-colors">
                                                    <td className="p-5 font-black text-slate-800">{item.kod}</td>
                                                    <td className="p-5 text-slate-500 font-bold max-w-xs">{item.program}</td>
                                                    <td className="p-5 text-right font-black text-blue-600">{formatCurrency(item.peruntukan)}</td>
                                                    <td className="p-5 text-right font-black text-orange-500">{formatCurrency(item.belanja)}</td>
                                                    <td className="p-5 text-center">
                                                        <button onClick={() => fetchDetail(item.program)} className="bg-slate-100 text-slate-800 px-4 py-2 rounded-xl text-[9px] font-black uppercase hover:bg-slate-900 hover:text-white transition-all active:scale-90">Perincian</button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div className="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden">
                            <div className="p-8 bg-slate-900 text-white">
                                <p className="text-[10px] font-black uppercase tracking-widest opacity-50 mb-1">Melihat Perincian Program</p>
                                <h2 className="text-xl font-black">{activeProgram}</h2>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left text-[11px]">
                                    <thead className="bg-slate-100 text-slate-400 font-black uppercase border-b">
                                        <tr>
                                            <th className="p-5">Bil</th>
                                            <th className="p-5">Kursus / Bengkel</th>
                                            <th className="p-5 text-right">Peruntukan</th>
                                            <th className="p-5 text-right">Belanja</th>
                                            <th className="p-5 text-center">Tarikh</th>
                                            <th className="p-5 text-center">Peserta</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {detailData.map((item, i) => (
                                            <tr key={i} className="hover:bg-slate-50">
                                                <td className="p-5 text-slate-400 font-bold">{item.bil}</td>
                                                <td className="p-5 font-bold text-slate-800 max-w-sm">{item.nama}</td>
                                                <td className="p-5 text-right font-bold text-blue-600">{formatCurrency(item.p_jum)}</td>
                                                <td className="p-5 text-right font-bold text-orange-600">{formatCurrency(item.b_jum)}</td>
                                                <td className="p-5 text-center text-slate-500 font-medium">{item.tarikh}</td>
                                                <td className="p-5 text-center font-black text-slate-700">{item.pax}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    <footer className="mt-20 mb-10 text-center">
                        <p className="text-slate-300 text-[10px] font-black uppercase tracking-[0.5em] italic">IAB INTEGRATED FINANCIAL DASHBOARD v3.0</p>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Kewangan LDP BPG 2026</title>
    
    <!-- Panggilan Library Luaran (Mesti ada Internet) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100">

    <!-- Skrin Loading Statik (Muncul sebelum React Sedia) -->
    <div id="fallback-ui" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50">
        <div class="w-12 h-12 border-4 border-slate-200 border-t-blue-600 rounded-full spin mb-4"></div>
        <h2 class="text-slate-800 font-bold">Menghubungkan ke Google Sheets...</h2>
        <p class="text-slate-400 text-xs mt-2">Pastikan fail ini dibuka menggunakan Browser (Chrome/Edge)</p>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Cell, PieChart, Pie } = Recharts;

        // =================================================================================
        // üîß KONFIGURASI LINK GOOGLE SHEET (LIVE CSV)
        // =================================================================================
        const SHEET_LINKS = {
            ANALISIS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZd2KLh_LqBhHbSkRKL0rsoESf60kgFSomuC8kwgZqkLbRvXyqWTqr2DoEzzP15BV491auFw3BdFKd/pub?gid=0&single=true&output=csv', 
            PROGRAMS: {
                'LDP-BPG-LEAD AUDITOR': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZd2KLh_LqBhHbSkRKL0rsoESf60kgFSomuC8kwgZqkLbRvXyqWTqr2DoEzzP15BV491auFw3BdFKd/pub?gid=1435925801&single=true&output=csv',
                'LDP-BPG-PEMERKASAAN COE': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZd2KLh_LqBhHbSkRKL0rsoESf60kgFSomuC8kwgZqkLbRvXyqWTqr2DoEzzP15BV491auFw3BdFKd/pub?gid=1031215483&single=true&output=csv',
                'LDP-BPG-CERTIFIED ASSESSOR': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZd2KLh_LqBhHbSkRKL0rsoESf60kgFSomuC8kwgZqkLbRvXyqWTqr2DoEzzP15BV491auFw3BdFKd/pub?gid=2077989648&single=true&output=csv'
            }
        };

        const formatCurrency = (val) => new Intl.NumberFormat('ms-MY', { style: 'currency', currency: 'MYR' }).format(val);

        const cleanNum = (str) => {
            if (!str) return 0;
            // Buang RM, koma, %, simbol petik dan ruang kosong
            let cleaned = str.replace(/[RM,\s%"$]/g, "");
            let num = parseFloat(cleaned);
            return isNaN(num) ? 0 : num;
        };

        const robustSplit = (line) => {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
                else current += char;
            }
            result.push(current.trim());
            return result;
        };

        function App() {
            const [data, setData] = useState([]);
            const [detailData, setDetailData] = useState([]);
            const [view, setView] = useState('summary'); // 'summary' atau 'detail'
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [activeProgram, setActiveProgram] = useState("");

            useEffect(() => {
                // Sembunyikan skrin loading statik
                const fb = document.getElementById('fallback-ui');
                if (fb) fb.style.display = 'none';
                fetchSummary();
            }, []);

            const fetchSummary = async () => {
                setLoading(true);
                setError(null);
                try {
                    const response = await fetch(SHEET_LINKS.ANALISIS);
                    if (!response.ok) throw new Error("Gagal akses fail. Sila pastikan Google Sheet dipublish sebagai CSV.");
                    
                    const text = await response.text();
                    if (text.includes("<!DOCTYPE html>")) throw new Error("Link salah! Ia memulangkan halaman HTML, bukan data CSV.");

                    const lines = text.split(/\r?\n/).filter(l => l.trim());
                    const parsed = [];
                    
                    lines.forEach((line) => {
                        const row = robustSplit(line);
                        // Logik: Data sebenar Analisis bermula dengan Kod 'SK' di kolum ke-2 (index 1)
                        if (row.length > 5 && row[1] && row[1].startsWith('SK')) {
                            parsed.push({
                                kod: row[1],
                                program: row[2].replace(/"/g, ''),
                                peruntukan: cleanNum(row[3]) + cleanNum(row[4]),
                                belanja: cleanNum(row[6]) + cleanNum(row[7]),
                            });
                        }
                    });

                    if (parsed.length === 0) throw new Error("Format data tidak dikenali. Pastikan tab ANALISIS mempunyai data.");
                    setData(parsed);
                } catch (err) {
                    setError(err.message);
                }
                setLoading(false);
            };

            const fetchDetail = async (progName) => {
                setLoading(true);
                setActiveProgram(progName);
                try {
                    const link = SHEET_LINKS.PROGRAMS[progName];
                    if (!link) throw new Error("Link program ini belum disetkan.");
                    
                    const response = await fetch(link);
                    const text = await response.text();
                    const lines = text.split(/\r?\n/).filter(l => l.trim());
                    
                    const parsed = [];
                    lines.forEach((line) => {
                        const row = robustSplit(line);
                        // Data perincian bermula dengan Bilangan (Angka) di index 0
                        if (row.length > 10 && !isNaN(parseInt(row[0]))) {
                            parsed.push({
                                bil: row[0],
                                nama: row[2].replace(/"/g, ''),
                                p_jum: cleanNum(row[5]),
                                b_jum: cleanNum(row[8]),
                                tarikh: `${row[12]} - ${row[13]}`,
                                bil_pes: row[14],
                                lokasi: row[15]
                            });
                        }
                    });
                    setDetailData(parsed);
                    setView('detail');
                } catch (err) {
                    alert("Ralat: " + err.message);
                }
                setLoading(false);
            };

            const totalP = data.reduce((a, b) => a + b.peruntukan, 0);
            const totalB = data.reduce((a, b) => a + b.belanja, 0);

            if (error) return (
                <div className="flex flex-col items-center justify-center h-screen p-8 text-center bg-white">
                    <div className="bg-red-50 p-10 rounded-[2.5rem] border-2 border-red-100 max-w-xl shadow-2xl shadow-red-100">
                        <div className="text-red-500 text-6xl mb-6">‚ö†Ô∏è</div>
                        <h2 className="text-2xl font-black text-red-800 mb-4 tracking-tighter uppercase">Ralat Pengambilan Data</h2>
                        <p className="text-slate-600 font-medium leading-relaxed mb-8">{error}</p>
                        <div className="bg-white p-4 rounded-2xl text-[11px] text-left text-slate-500 mb-8 border italic">
                            <b>Punca Biasa:</b><br/>
                            1. Google Sheet tidak di-'Publish to Web'.<br/>
                            2. Format fail dipilih bukan 'CSV'.<br/>
                            3. Anda tersalin 'Share Link' (bukan link publish).
                        </div>
                        <button onClick={() => window.location.reload()} className="bg-red-600 text-white px-10 py-3 rounded-2xl font-bold hover:bg-red-700 transition-all shadow-lg shadow-red-200 active:scale-95">RESTART DASHBOARD</button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen pb-20">
                    {/* Header bar */}
                    <div className="bg-white border-b border-slate-200 px-4 py-6 md:px-10 sticky top-0 z-40">
                        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="text-center md:text-left">
                                <h1 className="text-xl font-black text-slate-900 tracking-tight leading-none uppercase">DASHBOARD KEWANGAN 2026</h1>
                                <p className="text-[10px] text-slate-400 font-bold tracking-[0.2em] mt-1">PUSAT KEPIMPINAN PENDIDIKAN IAB</p>
                            </div>
                            <div className="flex gap-2">
                                {view === 'detail' && (
                                    <button onClick={() => setView('summary')} className="bg-white border border-slate-200 text-slate-700 px-5 py-2 rounded-xl text-[10px] font-black uppercase hover:bg-slate-50 transition shadow-sm">&larr; Balik</button>
                                )}
                                <button onClick={fetchSummary} className="bg-blue-600 text-white px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-wider hover:bg-blue-700 transition shadow-lg shadow-blue-100 active:scale-95">Refresh Data</button>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto p-4 md:p-10">
                        {view === 'summary' ? (
                            <div className="space-y-10">
                                {/* Kad Ringkasan */}
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div className="bg-white p-8 rounded-[2rem] shadow-sm border border-slate-100 relative overflow-hidden">
                                        <div className="absolute top-0 right-0 p-4 opacity-5 text-6xl">üí∞</div>
                                        <p className="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-2">Peruntukan</p>
                                        <h2 className="text-3xl font-black text-slate-800 tracking-tighter">{formatCurrency(totalP)}</h2>
                                    </div>
                                    <div className="bg-white p-8 rounded-[2rem] shadow-sm border border-slate-100 relative overflow-hidden">
                                        <div className="absolute top-0 right-0 p-4 opacity-5 text-6xl">üìà</div>
                                        <p className="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-2">Belanja</p>
                                        <h2 className="text-3xl font-black text-orange-600 tracking-tighter">{formatCurrency(totalB)}</h2>
                                    </div>
                                    <div className="bg-white p-8 rounded-[2rem] shadow-sm border border-slate-100 relative overflow-hidden">
                                        <div className="absolute top-0 right-0 p-4 opacity-5 text-6xl">‚úÖ</div>
                                        <p className="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-2">Baki Semasa</p>
                                        <h2 className="text-3xl font-black text-emerald-600 tracking-tighter">{formatCurrency(totalP - totalB)}</h2>
                                    </div>
                                </div>

                                {/* Graf Bar */}
                                <div className="bg-white p-6 md:p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                                    <div className="flex justify-between items-center mb-10">
                                        <h3 className="text-xs font-black text-slate-800 uppercase tracking-widest">Analisis Perbelanjaan Mengikut Modul</h3>
                                        <span className="text-[10px] text-slate-400 font-bold italic">Sektor LDP BPG 2026</span>
                                    </div>
                                    <div className="h-80">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <BarChart data={data} margin={{top: 0, right: 0, left: -20, bottom: 0}}>
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                                <XAxis dataKey="kod" axisLine={false} tickLine={false} tick={{fontSize: 10, fontWeight: 900, fill: '#64748b'}} />
                                                <YAxis hide />
                                                <Tooltip 
                                                    cursor={{fill: '#f8fafc'}}
                                                    contentStyle={{borderRadius: '20px', border: 'none', boxShadow: '0 20px 25px -5px rgba(0,0,0,0.1)'}}
                                                />
                                                <Bar dataKey="peruntukan" name="Peruntukan" fill="#3b82f6" radius={[6, 6, 0, 0]} barSize={40} />
                                                <Bar dataKey="belanja" name="Belanja" fill="#f97316" radius={[6, 6, 0, 0]} barSize={40} />
                                            </BarChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* Jadual Utama */}
                                <div className="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden">
                                    <div className="p-6 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                                        <h3 className="text-[10px] font-black text-slate-800 uppercase tracking-widest">Senarai Program Induk</h3>
                                        <div className="text-[9px] font-bold text-slate-400 bg-white px-3 py-1 rounded-full border">LIVE CONNECTED</div>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left text-[11px]">
                                            <thead>
                                                <tr className="text-slate-400 font-black uppercase border-b bg-slate-50/50">
                                                    <th className="p-5">Kod</th>
                                                    <th className="p-5">Program</th>
                                                    <th className="p-5 text-right">Peruntukan</th>
                                                    <th className="p-5 text-right">Belanja</th>
                                                    <th className="p-5 text-center">Tindakan</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {data.map((item, i) => (
                                                    <tr key={i} className="hover:bg-blue-50/30 transition-all group">
                                                        <td className="p-5 font-black text-slate-900">{item.kod}</td>
                                                        <td className="p-5 text-slate-500 font-bold group-hover:text-slate-800 transition-colors">{item.program}</td>
                                                        <td className="p-5 text-right font-black text-blue-600">{formatCurrency(item.peruntukan)}</td>
                                                        <td className="p-5 text-right font-black text-orange-500">{formatCurrency(item.belanja)}</td>
                                                        <td className="p-5 text-center">
                                                            <button 
                                                                onClick={() => fetchDetail(item.program)} 
                                                                className="bg-slate-900 text-white px-5 py-2 rounded-xl text-[9px] font-black uppercase tracking-wider hover:bg-blue-600 transition-all shadow-md active:scale-90"
                                                            >
                                                                Detail
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden animate-in fade-in slide-in-from-bottom-4 duration-500">
                                <div className="p-8 bg-slate-900 text-white flex flex-col md:flex-row justify-between items-center gap-6">
                                    <div className="text-center md:text-left">
                                        <p className="text-[10px] font-black uppercase tracking-[0.3em] opacity-50 mb-1">Perincian Kursus / Bengkel</p>
                                        <h2 className="text-2xl font-black tracking-tight">{activeProgram}</h2>
                                    </div>
                                    <div className="flex gap-10 bg-white/10 p-5 rounded-2xl backdrop-blur-sm border border-white/10">
                                        <div className="text-center">
                                            <p className="text-[9px] font-black opacity-50 uppercase mb-1">Peruntukan</p>
                                            <p className="font-black text-blue-400 text-lg">{formatCurrency(detailData.reduce((a,c)=>a+c.p_jum,0))}</p>
                                        </div>
                                        <div className="text-center">
                                            <p className="text-[9px] font-black opacity-50 uppercase mb-1">Belanja</p>
                                            <p className="font-black text-orange-400 text-lg">{formatCurrency(detailData.reduce((a,c)=>a+c.b_jum,0))}</p>
                                        </div>
                                    </div>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left text-[11px]">
                                        <thead className="bg-slate-50 text-slate-400 font-black uppercase border-b tracking-widest text-[10px]">
                                            <tr>
                                                <th className="p-5">Bil</th>
                                                <th className="p-5">Kursus / Bengkel</th>
                                                <th className="p-5 text-right">Peruntukan</th>
                                                <th className="p-5 text-right">Belanja</th>
                                                <th className="p-5 text-center">Lokasi</th>
                                                <th className="p-5 text-center">Bil. Peserta</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {detailData.map((item, i) => (
                                                <tr key={i} className="hover:bg-slate-50">
                                                    <td className="p-5 text-slate-400 font-bold">{item.bil}</td>
                                                    <td className="p-5 font-black text-slate-800 leading-relaxed max-w-sm">{item.nama}</td>
                                                    <td className="p-5 text-right font-black text-blue-600">{formatCurrency(item.p_jum)}</td>
                                                    <td className="p-5 text-right font-black text-orange-600">{formatCurrency(item.b_jum)}</td>
                                                    <td className="p-5 text-center text-slate-500 font-bold uppercase text-[10px]">{item.lokasi}</td>
                                                    <td className="p-5 text-center font-black text-slate-700 bg-slate-50/50">{item.bil_pes}</td>
                                                </tr>
                                            ))}
                                            {detailData.length === 0 && (
                                                <tr>
                                                    <td colSpan="6" className="p-20 text-center text-slate-400 italic font-bold">Tiada data perincian ditemui.</td>
                                                </tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        <div className="mt-20 text-center">
                            <p className="text-slate-300 text-[10px] font-black uppercase tracking-[0.5em] italic">IAB INTEGRATED FINANCIAL DASHBOARD v3.5</p>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Kewangan LDP 2026 (Versi Stabil)</title>
    
    <!-- Memuatkan React & Recharts dari CDN yang lebih stabil -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* Console Log Visual */
        #console-log {
            background: #0f172a; color: #38bdf8; font-family: monospace; font-size: 11px;
            padding: 10px; height: 120px; overflow-y: auto; border-top: 2px solid #3b82f6;
        }
        .log-err { color: #ef4444; }
        .log-ok { color: #4ade80; }
        .log-warn { color: #fbbf24; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div id="root" class="flex-grow"></div>

    <!-- Ruang Log Diagnostik -->
    <div id="console-log">
        <div>[SISTEM] Memulakan aplikasi...</div>
    </div>

    <script type="text/babel">
        // --- 1. FUNGSI LOGGING ---
        const log = (msg, type = 'info') => {
            const el = document.getElementById('console-log');
            if(el) {
                const div = document.createElement('div');
                div.textContent = `> ${msg}`;
                if(type === 'err') div.className = 'log-err';
                if(type === 'ok') div.className = 'log-ok';
                if(type === 'warn') div.className = 'log-warn';
                el.appendChild(div);
                el.scrollTop = el.scrollHeight;
            }
            if(type === 'err') console.error(msg); else console.log(msg);
        };

        // --- 2. DATA FALLBACK (Gunakan ini jika Google Sheet gagal ditarik) ---
        // Ini adalah data yang anda berikan dalam chat history.
        const FALLBACK_DATA = [
            { kod: 'SK145', program: 'LDP-BPG-LEAD AUDITOR', p21: 0, p29: 0, b21: 0, b29: 0, peruntukan: 0, belanja: 0 },
            { kod: 'SK146', program: 'LDP-BPG-PEMERKASAAN COE', p21: 30000, p29: 12600, b21: 0, b29: 0, peruntukan: 42600, belanja: 0 },
            { kod: 'SK147', program: 'LDP-BPG-CERTIFIED ASSESSOR', p21: 7000, p29: 2400, b21: 7000, b29: 2400, peruntukan: 9400, belanja: 9400 }
        ];

        // --- 3. KONFIGURASI GOOGLE SHEET ---
        const SHEET_LINKS = {
            ANALISIS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZd2KLh_LqBhHbSkRKL0rsoESf60kgFSomuC8kwgZqkLbRvXyqWTqr2DoEzzP15BV491auFw3BdFKd/pub?gid=0&single=true&output=csv', 
            PROGRAMS: {
                'LDP-BPG-LEAD AUDITOR': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZd2KLh_LqBhHbSkRKL0rsoESf60kgFSomuC8kwgZqkLbRvXyqWTqr2DoEzzP15BV491auFw3BdFKd/pub?gid=1435925801&single=true&output=csv',
                'LDP-BPG-PEMERKASAAN COE': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZd2KLh_LqBhHbSkRKL0rsoESf60kgFSomuC8kwgZqkLbRvXyqWTqr2DoEzzP15BV491auFw3BdFKd/pub?gid=1031215483&single=true&output=csv',
                'LDP-BPG-CERTIFIED ASSESSOR': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZd2KLh_LqBhHbSkRKL0rsoESf60kgFSomuC8kwgZqkLbRvXyqWTqr2DoEzzP15BV491auFw3BdFKd/pub?gid=2077989648&single=true&output=csv'
            }
        };

        const { useState, useEffect } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Cell, PieChart, Pie, ComposedChart, Line } = Recharts;

        // --- UTILITIES ---
        const formatCurrency = (val) => new Intl.NumberFormat('ms-MY', { style: 'currency', currency: 'MYR' }).format(val);
        
        const cleanNum = (str) => {
            if (!str || typeof str !== 'string') return 0;
            let cleaned = str.replace(/[RM,\s%"$]/g, "").trim();
            if (cleaned === "" || cleaned.includes("#DIV")) return 0;
            return parseFloat(cleaned) || 0;
        };

        const robustSplit = (line) => {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
                else current += char;
            }
            result.push(current.trim());
            return result;
        };

        function App() {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [source, setSource] = useState('INIT'); // 'LIVE' atau 'FALLBACK'
            const [detailData, setDetailData] = useState([]);
            const [view, setView] = useState('summary');
            const [activeProgram, setActiveProgram] = useState("");

            useEffect(() => {
                loadData();
            }, []);

            const loadData = async () => {
                log("Mula memuat turun data dari Google Sheets...", 'info');
                try {
                    // Cuba fetch dengan timeout 5 saat
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);

                    const response = await fetch(SHEET_LINKS.ANALISIS, { signal: controller.signal });
                    clearTimeout(timeoutId);

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const text = await response.text();
                    
                    if (text.includes("<!DOCTYPE html>")) throw new Error("Link memulangkan HTML, bukan CSV.");

                    log("Data berjaya diterima. Mula memproses...", 'ok');
                    const lines = text.split(/\r?\n/).filter(l => l.trim());
                    const parsed = [];

                    lines.forEach((line, index) => {
                        const row = robustSplit(line);
                        // Logik: Cari baris yang ada 'SK' di kolum 2 (Index 1) ATAU ada data di kolum Program
                        // Analisis CSV Structure: BIL, KOD, PROGRAM, OS21(P), OS29(P), JUMLAH(P), OS21(B), OS29(B)...
                        if (row.length > 5 && row[1] && row[1].includes('SK')) {
                            const p21 = cleanNum(row[3]);
                            const p29 = cleanNum(row[4]);
                            const b21 = cleanNum(row[6]);
                            const b29 = cleanNum(row[7]);
                            const totalP = p21 + p29;
                            const totalB = b21 + b29;
                            
                            // Kira peratus
                            let peratus = 0;
                            if(row[12]) peratus = cleanNum(row[12]);
                            else if(totalP > 0) peratus = (totalB / totalP) * 100;

                            parsed.push({
                                kod: row[1],
                                program: row[2].replace(/"/g, ''),
                                p21, p29, b21, b29,
                                peruntukan: totalP,
                                belanja: totalB,
                                baki: totalP - totalB,
                                peratus: parseFloat(peratus.toFixed(2))
                            });
                        }
                    });

                    if (parsed.length > 0) {
                        setData(parsed);
                        setSource('LIVE');
                        log(`Berjaya memproses ${parsed.length} rekod data sebenar.`, 'ok');
                    } else {
                        throw new Error("Tiada baris data yang sah dijumpai.");
                    }

                } catch (err) {
                    log(`Gagal memuat turun data Live: ${err.message}. Menggunakan data simpanan.`, 'err');
                    // Fallback logic
                    const mappedFallback = FALLBACK_DATA.map(d => ({
                        ...d,
                        peruntukan: d.p21 + d.p29,
                        belanja: d.b21 + d.b29,
                        baki: (d.p21 + d.p29) - (d.b21 + d.b29),
                        peratus: (d.p21 + d.p29) > 0 ? ((d.b21 + d.b29) / (d.p21 + d.p29) * 100) : 0
                    }));
                    setData(mappedFallback);
                    setSource('FALLBACK');
                }
                setLoading(false);
            };

            const loadDetail = async (progName) => {
                log(`Meminta perincian untuk: ${progName}`);
                setLoading(true);
                setActiveProgram(progName);
                
                try {
                    const link = SHEET_LINKS.PROGRAMS[progName];
                    if(!link) throw new Error("Tiada link program");

                    const response = await fetch(link);
                    const text = await response.text();
                    const lines = text.split(/\r?\n/).filter(l => l.trim());
                    const parsed = [];

                    lines.forEach(line => {
                        const row = robustSplit(line);
                        // Detail CSV: BIL(0), KOD(1), NAMA(2)...
                        if(row.length > 8 && !isNaN(parseInt(row[0]))) {
                            parsed.push({
                                bil: row[0],
                                nama: row[2].replace(/"/g, ''),
                                p_jum: cleanNum(row[5]),
                                b_jum: cleanNum(row[8]),
                                tarikh: `${row[12]||''} ${row[13]||''}`,
                                lokasi: row[15] || '-'
                            });
                        }
                    });
                    setDetailData(parsed);
                    setView('detail');
                    log(`Perincian berjaya: ${parsed.length} baris.`, 'ok');
                } catch(err) {
                    log(`Gagal perincian: ${err.message}`, 'err');
                    alert("Gagal memuat turun perincian program ini. Sila semak sambungan.");
                }
                setLoading(false);
            };

            // Calculations
            const sumP21 = data.reduce((a, b) => a + (b.p21 || 0), 0);
            const sumP29 = data.reduce((a, b) => a + (b.p29 || 0), 0);
            const sumB21 = data.reduce((a, b) => a + (b.b21 || 0), 0);
            const sumB29 = data.reduce((a, b) => a + (b.b29 || 0), 0);
            const grandTotalP = sumP21 + sumP29;
            const grandTotalB = sumB21 + sumB29;
            const globalPercent = grandTotalP > 0 ? (grandTotalB / grandTotalP) * 100 : 0;

            const pieData = [
                { name: 'OS21000', value: sumP21, color: '#3b82f6' },
                { name: 'OS29000', value: sumP29, color: '#a855f7' }
            ];

            if (loading) return (
                <div className="flex h-screen items-center justify-center bg-slate-50 flex-col">
                    <div className="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full spin mb-4"></div>
                    <p className="text-slate-500 font-medium animate-pulse">Sedang berkomunikasi dengan Google Sheets...</p>
                </div>
            );

            return (
                <div className="p-4 md:p-8 max-w-7xl mx-auto">
                    {/* Header */}
                    <div className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                        <div>
                            <h1 className="text-xl md:text-2xl font-black text-slate-800 uppercase tracking-tight">Analisis Kewangan LDP 2026</h1>
                            <div className="flex items-center gap-2 mt-1">
                                <span className={`w-2 h-2 rounded-full ${source === 'LIVE' ? 'bg-emerald-500' : 'bg-amber-500'}`}></span>
                                <p className="text-xs font-bold text-slate-500 uppercase tracking-widest">
                                    SUMBER DATA: {source === 'LIVE' ? 'GOOGLE SHEETS (LIVE)' : 'DATA SIMPANAN (OFFLINE)'}
                                </p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            {view === 'detail' && (
                                <button onClick={() => setView('summary')} className="bg-slate-100 px-4 py-2 rounded-lg text-xs font-bold hover:bg-slate-200">KEMBALI</button>
                            )}
                            <button onClick={loadData} className="bg-slate-900 text-white px-6 py-2 rounded-lg text-xs font-bold hover:bg-black shadow-lg shadow-slate-300">REFRESH</button>
                        </div>
                    </div>

                    {source === 'FALLBACK' && (
                        <div className="bg-amber-50 border border-amber-200 text-amber-800 p-3 rounded-xl text-xs text-center mb-6 font-medium">
                            ⚠️ Sistem gagal menyambung ke Google Sheets. Memaparkan data simpanan terakhir. Sila semak Console Log di bawah untuk punca ralat.
                        </div>
                    )}

                    {view === 'summary' ? (
                        <div className="space-y-8 animate-fade-in">
                            {/* Cards */}
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
                                    <p className="text-[10px] text-slate-400 font-black uppercase mb-1">Peruntukan OS21</p>
                                    <h2 className="text-xl font-black text-slate-800">{formatCurrency(sumP21)}</h2>
                                    <div className="w-full bg-slate-100 h-1 mt-2 rounded-full"><div className="bg-blue-500 h-1 rounded-full" style={{width: `${sumP21/grandTotalP*100}%`}}></div></div>
                                </div>
                                <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
                                    <p className="text-[10px] text-slate-400 font-black uppercase mb-1">Peruntukan OS29</p>
                                    <h2 className="text-xl font-black text-slate-800">{formatCurrency(sumP29)}</h2>
                                    <div className="w-full bg-slate-100 h-1 mt-2 rounded-full"><div className="bg-purple-500 h-1 rounded-full" style={{width: `${sumP29/grandTotalP*100}%`}}></div></div>
                                </div>
                                <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
                                    <p className="text-[10px] text-slate-400 font-black uppercase mb-1">Belanja Semasa</p>
                                    <h2 className="text-xl font-black text-orange-500">{formatCurrency(grandTotalB)}</h2>
                                    <p className="text-[10px] text-slate-400 mt-1 font-bold">{globalPercent.toFixed(1)}% Digunakan</p>
                                </div>
                                <div className="bg-slate-900 p-5 rounded-2xl shadow-lg text-white">
                                    <p className="text-[10px] text-slate-400 font-black uppercase mb-1">Baki Bersih</p>
                                    <h2 className="text-xl font-black">{formatCurrency(grandTotalP - grandTotalB)}</h2>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                {/* Bar Chart */}
                                <div className="lg:col-span-2 bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm">
                                    <h3 className="text-xs font-black text-slate-800 uppercase tracking-widest mb-6">Prestasi Kategori (RM)</h3>
                                    <div className="h-72 w-full">
                                        <ResponsiveContainer>
                                            <ComposedChart data={data}>
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                                <XAxis dataKey="kod" tick={{fontSize: 10, fontWeight: 700}} axisLine={false} tickLine={false} />
                                                <YAxis hide />
                                                <Tooltip contentStyle={{borderRadius: '12px', border: 'none', boxShadow: '0 10px 15px -3px rgba(0,0,0,0.1)'}} formatter={(val) => formatCurrency(val)} />
                                                <Bar dataKey="p21" stackId="a" fill="#3b82f6" barSize={30} radius={[0,0,4,4]} name="OS21 (P)" />
                                                <Bar dataKey="p29" stackId="a" fill="#a855f7" barSize={30} radius={[4,4,0,0]} name="OS29 (P)" />
                                                <Line type="monotone" dataKey="belanja" stroke="#f97316" strokeWidth={3} dot={false} name="Belanja Total" />
                                            </ComposedChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* Pie Chart */}
                                <div className="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm flex flex-col justify-center">
                                    <h3 className="text-xs font-black text-slate-800 uppercase tracking-widest mb-2 text-center">Pecahan Bajet</h3>
                                    <div className="h-64 w-full">
                                        <ResponsiveContainer>
                                            <PieChart>
                                                <Pie data={pieData} cx="50%" cy="50%" innerRadius={60} outerRadius={80} paddingAngle={5} dataKey="value">
                                                    {pieData.map((entry, index) => (
                                                        <Cell key={`cell-${index}`} fill={entry.color} />
                                                    ))}
                                                </Pie>
                                                <Tooltip formatter={(val) => formatCurrency(val)} />
                                                <Legend verticalAlign="bottom" height={36} />
                                            </PieChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>
                            </div>

                            {/* Table */}
                            <div className="bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden">
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left text-xs">
                                        <thead className="bg-slate-50 text-slate-500 font-black uppercase tracking-widest border-b">
                                            <tr>
                                                <th className="p-5">Kod</th>
                                                <th className="p-5">Program</th>
                                                <th className="p-5 text-right text-blue-600 bg-blue-50/50">OS21 (P)</th>
                                                <th className="p-5 text-right text-purple-600 bg-purple-50/50">OS29 (P)</th>
                                                <th className="p-5 text-right text-orange-600">Belanja</th>
                                                <th className="p-5 text-center">Tindakan</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-50">
                                            {data.map((item, i) => (
                                                <tr key={i} className="hover:bg-slate-50 transition-colors">
                                                    <td className="p-5 font-black text-slate-800">{item.kod}</td>
                                                    <td className="p-5 font-bold text-slate-600">{item.program}</td>
                                                    <td className="p-5 text-right font-medium text-slate-500 bg-blue-50/10">{formatCurrency(item.p21)}</td>
                                                    <td className="p-5 text-right font-medium text-slate-500 bg-purple-50/10">{formatCurrency(item.p29)}</td>
                                                    <td className="p-5 text-right font-black text-orange-500">{formatCurrency(item.belanja)}</td>
                                                    <td className="p-5 text-center">
                                                        <button onClick={() => loadDetail(item.program)} className="bg-white border border-slate-200 px-3 py-1 rounded-lg text-[10px] font-black uppercase hover:bg-slate-800 hover:text-white transition shadow-sm">
                                                            Detail
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div className="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm animate-fade-in">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-lg font-black text-slate-800 uppercase">{activeProgram}</h2>
                                <div className="text-xs bg-blue-50 text-blue-600 px-3 py-1 rounded-full font-bold">PERINCIAN</div>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left text-xs">
                                    <thead className="bg-slate-50 text-slate-500 font-black uppercase tracking-widest border-b">
                                        <tr>
                                            <th className="p-4">Bil</th>
                                            <th className="p-4">Nama Kursus</th>
                                            <th className="p-4 text-right">Peruntukan</th>
                                            <th className="p-4 text-right">Belanja</th>
                                            <th className="p-4 text-center">Tarikh</th>
                                            <th className="p-4 text-center">Lokasi</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-50">
                                        {detailData.length > 0 ? detailData.map((d, i) => (
                                            <tr key={i}>
                                                <td className="p-4 font-bold text-slate-400">{d.bil}</td>
                                                <td className="p-4 font-bold text-slate-700">{d.nama}</td>
                                                <td className="p-4 text-right text-blue-600 font-bold">{formatCurrency(d.p_jum)}</td>
                                                <td className="p-4 text-right text-orange-500 font-bold">{formatCurrency(d.b_jum)}</td>
                                                <td className="p-4 text-center text-slate-500">{d.tarikh}</td>
                                                <td className="p-4 text-center text-slate-500 text-[10px] uppercase">{d.lokasi}</td>
                                            </tr>
                                        )) : (
                                            <tr><td colSpan="6" className="p-10 text-center italic text-slate-400">Tiada data dijumpai atau pautan tidak sah.</td></tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

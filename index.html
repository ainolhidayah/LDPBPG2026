<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Analisis Kewangan LDP 2026 (Debug Mode)</title>
    
    <!-- Library Luaran (Versi Stabil) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        /* Log Console pada skrin untuk debugging */
        #debug-console {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 150px;
            background: #1e293b; color: #38bdf8; font-family: monospace; font-size: 12px;
            overflow-y: auto; padding: 10px; z-index: 9999; border-top: 2px solid #3b82f6;
            display: block; /* Tukar ke 'none' jika sudah ok */
        }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #334155; padding-bottom: 2px; }
        .log-error { color: #f87171; font-weight: bold; }
        .log-success { color: #4ade80; }
    </style>
</head>
<body>

    <div id="root"></div>
    
    <!-- Kotak Log untuk melihat error -->
    <div id="debug-console">
        <div class="log-line">--- SISTEM DIAGNOSTIK DIMULAKAN ---</div>
    </div>

    <script type="text/babel">
        // Fungsi Logger Custom
        function log(msg, type = 'info') {
            const consoleDiv = document.getElementById('debug-console');
            const line = document.createElement('div');
            line.className = `log-line ${type === 'error' ? 'log-error' : type === 'success' ? 'log-success' : ''}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            consoleDiv.appendChild(line);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            if (type === 'error') console.error(msg);
            else console.log(msg);
        }

        log("Memuatkan React & Recharts...");

        const { useState, useEffect } = React;
        const { 
            BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, 
            ResponsiveContainer, Cell, PieChart, Pie, ComposedChart, Line
        } = Recharts;

        // =================================================================================
        // ðŸ”§ KONFIGURASI LINK GOOGLE SHEET (LIVE CSV)
        // =================================================================================
        const SHEET_LINKS = {
            ANALISIS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZd2KLh_LqBhHbSkRKL0rsoESf60kgFSomuC8kwgZqkLbRvXyqWTqr2DoEzzP15BV491auFw3BdFKd/pub?gid=0&single=true&output=csv', 
            PROGRAMS: {
                'LDP-BPG-LEAD AUDITOR': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZd2KLh_LqBhHbSkRKL0rsoESf60kgFSomuC8kwgZqkLbRvXyqWTqr2DoEzzP15BV491auFw3BdFKd/pub?gid=1435925801&single=true&output=csv',
                'LDP-BPG-PEMERKASAAN COE': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZd2KLh_LqBhHbSkRKL0rsoESf60kgFSomuC8kwgZqkLbRvXyqWTqr2DoEzzP15BV491auFw3BdFKd/pub?gid=1031215483&single=true&output=csv',
                'LDP-BPG-CERTIFIED ASSESSOR': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZd2KLh_LqBhHbSkRKL0rsoESf60kgFSomuC8kwgZqkLbRvXyqWTqr2DoEzzP15BV491auFw3BdFKd/pub?gid=2077989648&single=true&output=csv'
            }
        };

        const formatCurrency = (val) => new Intl.NumberFormat('ms-MY', { style: 'currency', currency: 'MYR' }).format(val);

        const cleanNum = (str) => {
            if (!str || typeof str !== 'string') return 0;
            // Handle #DIV/0! error dari Excel
            if (str.includes('#DIV/0') || str.includes('#VALUE')) return 0;
            let cleaned = str.replace(/[RM,\s%"$]/g, "").trim();
            if (cleaned === "") return 0;
            let num = parseFloat(cleaned);
            return isNaN(num) ? 0 : num;
        };

        const robustSplit = (line) => {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
                else current += char;
            }
            result.push(current.trim());
            return result;
        };

        function App() {
            log("Komponen App dimulakan...");
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [lastUpdated, setLastUpdated] = useState("");

            useEffect(() => {
                fetchSummary();
            }, []);

            const fetchSummary = async () => {
                setLoading(true);
                setError(null);
                log("Mula memuat turun data ANALISIS...", 'info');
                
                try {
                    const response = await fetch(SHEET_LINKS.ANALISIS);
                    if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                    
                    const text = await response.text();
                    
                    // Semak jika Google hantar HTML (Login page) bukannya CSV
                    if (text.trim().startsWith("<!DOCTYPE html>") || text.includes("<html")) {
                        throw new Error("Pautan CSV memulangkan HTML. Mungkin fail tidak 'Publish to Web' atau link salah.");
                    }

                    log("Data berjaya dimuat turun (" + text.length + " bytes). Mula memproses...", 'success');

                    const lines = text.split(/\r?\n/).filter(l => l.trim());
                    const parsed = [];
                    
                    lines.forEach((line, idx) => {
                        const row = robustSplit(line);
                        // Debug baris pertama untuk pastikan format
                        if (idx < 5) log(`Baris ${idx}: ${row.join(' | ')}`);

                        // Logik: Data dalam ANALISIS.csv biasanya bermula dengan 'SK' di kolum 2
                        if (row.length > 5 && row[1] && row[1].startsWith('SK')) {
                            const p21 = cleanNum(row[3]);
                            const p29 = cleanNum(row[4]);
                            const b21 = cleanNum(row[6]);
                            const b29 = cleanNum(row[7]);
                            const totalP = p21 + p29;
                            const totalB = b21 + b29;
                            
                            // Ambil peratus dari lajur jika ada, atau kira sendiri
                            let peratus = 0;
                            if (row[12]) {
                                peratus = cleanNum(row[12]);
                            } else {
                                peratus = totalP > 0 ? (totalB / totalP) * 100 : 0;
                            }

                            parsed.push({
                                kod: row[1],
                                program: row[2].replace(/"/g, ''),
                                p21, p29, b21, b29,
                                peruntukan: totalP,
                                belanja: totalB,
                                baki: totalP - totalB,
                                peratus: parseFloat(peratus.toFixed(2))
                            });
                        }
                    });

                    log(`Proses tamat. ${parsed.length} program dijumpai.`, 'success');

                    if (parsed.length === 0) {
                        throw new Error("Tiada baris data yang bermula dengan 'SK' dijumpai. Sila semak format CSV.");
                    }
                    
                    setData(parsed);
                    setLastUpdated(new Date().toLocaleTimeString());
                } catch (err) {
                    log(`RALAT UTAMA: ${err.message}`, 'error');
                    setError(err.message);
                }
                setLoading(false);
            };

            // Rumusan Kategori
            const sumP21 = data.reduce((a, b) => a + b.p21, 0);
            const sumP29 = data.reduce((a, b) => a + b.p29, 0);
            const sumB21 = data.reduce((a, b) => a + b.b21, 0);
            const sumB29 = data.reduce((a, b) => a + b.b29, 0);
            const grandTotalP = sumP21 + sumP29;
            const grandTotalB = sumB21 + sumB29;
            const globalPeratus = grandTotalP > 0 ? (grandTotalB / grandTotalP) * 100 : 0;

            const pieData = [
                { name: 'OS21000', value: sumP21, color: '#2563eb' },
                { name: 'OS29000', value: sumP29, color: '#9333ea' }
            ];

            if (loading) return (
                <div className="flex flex-col items-center justify-center h-screen bg-slate-50">
                    <div className="w-16 h-16 border-4 border-slate-200 border-t-blue-600 rounded-full spin mb-4"></div>
                    <h2 className="text-slate-800 font-bold">Sedang Memproses Data...</h2>
                    <p className="text-xs text-slate-500 mt-2">Sila lihat log di bawah</p>
                </div>
            );

            if (error) return (
                <div className="flex flex-col items-center justify-center h-screen p-8 bg-red-50 text-center">
                    <h1 className="text-3xl font-black text-red-600 mb-4">RALAT SISTEM</h1>
                    <p className="text-red-800 font-bold mb-4">{error}</p>
                    <button onClick={fetchSummary} className="bg-red-600 text-white px-6 py-2 rounded-lg font-bold">Cuba Semula</button>
                    <p className="text-xs text-red-500 mt-8">Sila semak kotak hitam di bawah untuk perincian ralat.</p>
                </div>
            );

            return (
                <div className="min-h-screen pb-40">
                    {/* Top Bar */}
                    <div className="bg-white/80 backdrop-blur-md border-b sticky top-0 z-40 px-6 py-4 flex flex-col md:flex-row justify-between items-center gap-4 shadow-sm">
                        <div className="flex items-center gap-3">
                            <div className="bg-blue-600 p-2 rounded-xl text-white shadow-lg shadow-blue-200">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>
                            </div>
                            <div>
                                <h1 className="text-lg font-black text-slate-900 leading-none uppercase tracking-tighter">Analisis Kewangan LDP 2026</h1>
                                <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Status: <span className="text-emerald-500 italic">Connected</span></p>
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                            <button onClick={fetchSummary} className="bg-slate-900 text-white px-6 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-black transition-all shadow-md active:scale-95">Segarkan</button>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto p-6 lg:p-10 space-y-10 animate-in fade-in slide-in-from-bottom-4 duration-500">
                        
                        {/* Summary Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div className="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm">
                                <p className="text-[10px] text-slate-400 font-black uppercase tracking-[0.2em] mb-1">Peruntukan OS21000</p>
                                <h2 className="text-2xl font-black text-slate-800 tracking-tighter">{formatCurrency(sumP21)}</h2>
                                <div className="mt-2 h-1.5 w-full bg-slate-50 rounded-full overflow-hidden">
                                    <div className="h-full bg-blue-500 transition-all duration-1000" style={{width: `${sumP21 > 0 ? (sumB21/sumP21*100) : 0}%`}}></div>
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm">
                                <p className="text-[10px] text-slate-400 font-black uppercase tracking-[0.2em] mb-1">Peruntukan OS29000</p>
                                <h2 className="text-2xl font-black text-slate-800 tracking-tighter">{formatCurrency(sumP29)}</h2>
                                <div className="mt-2 h-1.5 w-full bg-slate-50 rounded-full overflow-hidden">
                                    <div className="h-full bg-purple-500 transition-all duration-1000" style={{width: `${sumP29 > 0 ? (sumB29/sumP29*100) : 0}%`}}></div>
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm bg-gradient-to-br from-white to-orange-50/30">
                                <p className="text-[10px] text-slate-400 font-black uppercase tracking-[0.2em] mb-1">Belanja Keseluruhan</p>
                                <h2 className="text-2xl font-black text-orange-600 tracking-tighter">{formatCurrency(grandTotalB)}</h2>
                            </div>
                            <div className="bg-slate-900 p-6 rounded-[2rem] text-white shadow-2xl shadow-slate-200">
                                <p className="text-[10px] text-slate-500 font-black uppercase tracking-[0.2em] mb-1">Baki Semasa</p>
                                <h2 className="text-2xl font-black tracking-tighter">{formatCurrency(grandTotalP - grandTotalB)}</h2>
                            </div>
                        </div>

                        {/* Main Charts */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div className="lg:col-span-2 bg-white p-8 rounded-[3rem] border border-slate-100 shadow-sm">
                                <div className="flex justify-between items-center mb-10">
                                    <h3 className="text-sm font-black text-slate-800 uppercase tracking-widest">Prestasi Mengikut Modul</h3>
                                    <div className="flex gap-4">
                                        <div className="flex items-center gap-2"><div className="w-2 h-2 bg-blue-500 rounded-full"></div><span className="text-[9px] font-bold text-slate-500">OS21</span></div>
                                        <div className="flex items-center gap-2"><div className="w-2 h-2 bg-purple-500 rounded-full"></div><span className="text-[9px] font-bold text-slate-500">OS29</span></div>
                                    </div>
                                </div>
                                <div className="h-80 w-full">
                                    <ResponsiveContainer>
                                        <ComposedChart data={data}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                            <XAxis dataKey="kod" axisLine={false} tickLine={false} tick={{fontSize: 10, fontWeight: 800, fill: '#94a3b8'}} />
                                            <YAxis hide />
                                            <Tooltip 
                                                cursor={{fill: '#f8fafc'}}
                                                contentStyle={{borderRadius: '24px', border: 'none', boxShadow: '0 20px 25px -5px rgba(0,0,0,0.1)'}}
                                                formatter={(val) => formatCurrency(val)}
                                            />
                                            <Bar dataKey="p21" name="Peruntukan OS21" fill="#3b82f6" radius={[4, 4, 0, 0]} barSize={20} />
                                            <Bar dataKey="p29" name="Peruntukan OS29" fill="#a855f7" radius={[4, 4, 0, 0]} barSize={20} />
                                            <Line type="monotone" dataKey="peratus" name="Peratus Guna (%)" stroke="#f97316" strokeWidth={3} dot={{r: 4}} />
                                        </ComposedChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>

                            <div className="bg-white p-8 rounded-[3rem] border border-slate-100 shadow-sm flex flex-col">
                                <h3 className="text-sm font-black text-slate-800 uppercase tracking-widest mb-6">Pecahan Peruntukan</h3>
                                <div className="flex-grow min-h-[300px]">
                                    <ResponsiveContainer>
                                        <PieChart>
                                            <Pie
                                                data={pieData}
                                                cx="50%" cy="50%"
                                                innerRadius={65}
                                                outerRadius={95}
                                                paddingAngle={8}
                                                dataKey="value"
                                                stroke="none"
                                            >
                                                {pieData.map((entry, index) => (
                                                    <Cell key={`cell-${index}`} fill={entry.color} />
                                                ))}
                                            </Pie>
                                            <Tooltip formatter={(val) => formatCurrency(val)} />
                                            <Legend verticalAlign="bottom" align="center" iconType="circle" wrapperStyle={{paddingTop: '20px', fontSize: '10px', fontWeight: 'bold'}} />
                                        </PieChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        </div>

                        {/* Detailed Table */}
                        <div className="bg-white rounded-[3rem] border border-slate-100 shadow-sm overflow-hidden">
                            <div className="p-8 border-b bg-slate-50/50 flex justify-between items-center">
                                <h3 className="text-sm font-black text-slate-800 uppercase tracking-widest">Analisis Terperinci OS21 & OS29</h3>
                                <span className="bg-blue-600 text-white w-6 h-6 flex items-center justify-center rounded-full text-[10px] font-bold">{data.length}</span>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left text-xs border-collapse">
                                    <thead>
                                        <tr className="bg-slate-50/80 text-slate-400 font-black uppercase tracking-widest text-[9px] border-b">
                                            <th className="p-6">Kod & Program</th>
                                            <th className="p-6 text-center border-l bg-blue-50/20">OS21 (P)</th>
                                            <th className="p-6 text-center bg-blue-50/20">OS21 (B)</th>
                                            <th className="p-6 text-center border-l bg-purple-50/20">OS29 (P)</th>
                                            <th className="p-6 text-center bg-purple-50/20">OS29 (B)</th>
                                            <th className="p-6 text-right border-l">Baki (RM)</th>
                                            <th className="p-6 text-right">% Belanja</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-50 font-medium text-slate-600">
                                        {data.map((item, i) => (
                                            <tr key={i} className="hover:bg-slate-50/50 transition-colors group">
                                                <td className="p-6">
                                                    <span className="font-black text-slate-900 block group-hover:text-blue-600 transition-colors">{item.kod}</span>
                                                    <span className="text-[10px] text-slate-400 font-bold leading-tight">{item.program}</span>
                                                </td>
                                                <td className="p-6 text-center bg-blue-50/5">{formatCurrency(item.p21)}</td>
                                                <td className="p-6 text-center font-bold text-blue-600 bg-blue-50/5">{formatCurrency(item.b21)}</td>
                                                <td className="p-6 text-center bg-purple-50/5">{formatCurrency(item.p29)}</td>
                                                <td className="p-6 text-center font-bold text-purple-600 bg-purple-50/5">{formatCurrency(item.b29)}</td>
                                                <td className="p-6 text-right font-black text-slate-800">{formatCurrency(item.baki)}</td>
                                                <td className="p-6 text-right">
                                                    <div className="flex flex-col items-end">
                                                        <span className={`text-[11px] font-black px-3 py-1 rounded-lg ${item.peratus > 90 ? 'bg-red-100 text-red-600' : 'bg-emerald-100 text-emerald-600'}`}>
                                                            {item.peratus}%
                                                        </span>
                                                        <div className="w-16 h-1.5 bg-slate-100 rounded-full mt-2 overflow-hidden">
                                                            <div className={`h-full ${item.peratus > 90 ? 'bg-red-500' : 'bg-emerald-500'}`} style={{width: `${item.peratus}%`}}></div>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

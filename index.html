<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Analisis Kumpulan Perbelanjaan 2026</title>
    
    <!-- Library Luaran -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .custom-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02); }
    </style>
</head>
<body>

    <div id="fallback-ui" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50">
        <div class="w-12 h-12 border-4 border-slate-100 border-t-blue-600 rounded-full spin mb-4"></div>
        <h2 class="text-slate-800 font-bold tracking-tight">Menjana Analisis Kategori...</h2>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { 
            BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, 
            ResponsiveContainer, Cell, PieChart, Pie, LineChart, Line 
        } = Recharts;

        // =================================================================================
        // üîß KONFIGURASI LINK GOOGLE SHEET (LIVE CSV)
        // =================================================================================
        const SHEET_LINKS = {
            ANALISIS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZd2KLh_LqBhHbSkRKL0rsoESf60kgFSomuC8kwgZqkLbRvXyqWTqr2DoEzzP15BV491auFw3BdFKd/pub?gid=0&single=true&output=csv', 
            PROGRAMS: {
                'LDP-BPG-LEAD AUDITOR': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZd2KLh_LqBhHbSkRKL0rsoESf60kgFSomuC8kwgZqkLbRvXyqWTqr2DoEzzP15BV491auFw3BdFKd/pub?gid=1435925801&single=true&output=csv',
                'LDP-BPG-PEMERKASAAN COE': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZd2KLh_LqBhHbSkRKL0rsoESf60kgFSomuC8kwgZqkLbRvXyqWTqr2DoEzzP15BV491auFw3BdFKd/pub?gid=1031215483&single=true&output=csv',
                'LDP-BPG-CERTIFIED ASSESSOR': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZd2KLh_LqBhHbSkRKL0rsoESf60kgFSomuC8kwgZqkLbRvXyqWTqr2DoEzzP15BV491auFw3BdFKd/pub?gid=2077989648&single=true&output=csv'
            }
        };

        const formatCurrency = (val) => new Intl.NumberFormat('ms-MY', { style: 'currency', currency: 'MYR' }).format(val);

        const cleanNum = (str) => {
            if (!str) return 0;
            let cleaned = str.replace(/[RM,\s%"$]/g, "");
            let num = parseFloat(cleaned);
            return isNaN(num) ? 0 : num;
        };

        const robustSplit = (line) => {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
                else current += char;
            }
            result.push(current.trim());
            return result;
        };

        function App() {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                const fb = document.getElementById('fallback-ui');
                if (fb) fb.style.display = 'none';
                fetchSummary();
            }, []);

            const fetchSummary = async () => {
                setLoading(true);
                setError(null);
                try {
                    const response = await fetch(SHEET_LINKS.ANALISIS);
                    if (!response.ok) throw new Error("Gagal akses data. Sila semak pautan Google Sheet.");
                    
                    const text = await response.text();
                    const lines = text.split(/\r?\n/).filter(l => l.trim());
                    const parsed = [];
                    
                    lines.forEach((line) => {
                        const row = robustSplit(line);
                        if (row.length > 5 && row[1] && row[1].startsWith('SK')) {
                            const p21 = cleanNum(row[3]);
                            const p29 = cleanNum(row[4]);
                            const b21 = cleanNum(row[6]);
                            const b29 = cleanNum(row[7]);
                            const totalP = p21 + p29;
                            const totalB = b21 + b29;
                            const peratus = totalP > 0 ? (totalB / totalP) * 100 : 0;

                            parsed.push({
                                kod: row[1],
                                program: row[2].replace(/"/g, ''),
                                p21, p29, b21, b29,
                                totalP, totalB,
                                peratus: peratus.toFixed(2),
                                baki: totalP - totalB
                            });
                        }
                    });

                    if (parsed.length === 0) throw new Error("Format data tidak ditemui. Pastikan tab ANALISIS mempunyai data yang betul.");
                    setData(parsed);
                } catch (err) {
                    setError(err.message);
                }
                setLoading(false);
            };

            // Rumusan Kategori
            const sumP21 = data.reduce((a, b) => a + b.p21, 0);
            const sumP29 = data.reduce((a, b) => a + b.p29, 0);
            const sumB21 = data.reduce((a, b) => a + b.b21, 0);
            const sumB29 = data.reduce((a, b) => a + b.b29, 0);
            const grandTotalP = sumP21 + sumP29;
            const grandTotalB = sumB21 + sumB29;

            const pieData = [
                { name: 'OS21000', value: sumP21, color: '#3b82f6' },
                { name: 'OS29000', value: sumP29, color: '#8b5cf6' }
            ];

            const peratusKeseluruhan = grandTotalP > 0 ? (grandTotalB / grandTotalP) * 100 : 0;

            if (error) return (
                <div className="flex flex-col items-center justify-center h-screen p-8 text-center">
                    <div className="bg-white p-10 rounded-[2rem] border border-red-100 max-w-lg shadow-xl">
                        <div className="text-red-500 text-6xl mb-4">‚ö†Ô∏è</div>
                        <h2 className="text-xl font-bold text-red-800 mb-2 uppercase">Ralat Analisis</h2>
                        <p className="text-slate-500 text-sm mb-6">{error}</p>
                        <button onClick={fetchSummary} className="bg-slate-900 text-white px-8 py-2 rounded-xl font-bold hover:bg-black transition">Cuba Lagi</button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen p-4 md:p-8 lg:p-12">
                    {/* Header */}
                    <div className="max-w-7xl mx-auto mb-10 flex flex-col md:flex-row justify-between items-center gap-6">
                        <div className="text-center md:text-left">
                            <h1 className="text-3xl font-black text-slate-900 tracking-tighter uppercase leading-none">Analisis Kumpulan Perbelanjaan</h1>
                            <p className="text-slate-400 text-xs font-bold tracking-[0.2em] mt-2 uppercase">LDP BPG IAB 2026 ‚Ä¢ OS21000 & OS29000</p>
                        </div>
                        <div className="flex items-center gap-4 bg-white p-2 rounded-2xl shadow-sm border border-slate-200">
                            <div className="px-4 py-2">
                                <p className="text-[10px] font-black text-slate-400 uppercase">Peratus Belanja (G)</p>
                                <p className="text-xl font-black text-blue-600">{peratusKeseluruhan.toFixed(1)}%</p>
                            </div>
                            <button onClick={fetchSummary} className="bg-slate-900 text-white p-4 rounded-xl hover:bg-black transition shadow-lg active:scale-95">
                                üîÑ
                            </button>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto space-y-8">
                        
                        {/* Summary Section */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div className="bg-white p-6 rounded-[2rem] border border-slate-100 custom-shadow">
                                <p className="text-[10px] text-slate-400 font-black uppercase mb-1">Peruntukan OS21000</p>
                                <h3 className="text-xl font-black text-slate-800">{formatCurrency(sumP21)}</h3>
                                <div className="mt-4 h-1 w-full bg-slate-50 rounded-full overflow-hidden">
                                    <div className="h-full bg-blue-500" style={{width: `${sumP21/grandTotalP*100}%`}}></div>
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-[2rem] border border-slate-100 custom-shadow">
                                <p className="text-[10px] text-slate-400 font-black uppercase mb-1">Peruntukan OS29000</p>
                                <h3 className="text-xl font-black text-slate-800">{formatCurrency(sumP29)}</h3>
                                <div className="mt-4 h-1 w-full bg-slate-50 rounded-full overflow-hidden">
                                    <div className="h-full bg-purple-500" style={{width: `${sumP29/grandTotalP*100}%`}}></div>
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-[2rem] border border-slate-100 custom-shadow">
                                <p className="text-[10px] text-slate-400 font-black uppercase mb-1">Belanja OS21000</p>
                                <h3 className="text-xl font-black text-orange-600">{formatCurrency(sumB21)}</h3>
                                <p className="text-[9px] font-bold text-slate-400 mt-2 italic">{sumP21 > 0 ? (sumB21/sumP21*100).toFixed(1) : 0}% Digunakan</p>
                            </div>
                            <div className="bg-white p-6 rounded-[2rem] border border-slate-100 custom-shadow">
                                <p className="text-[10px] text-slate-400 font-black uppercase mb-1">Belanja OS29000</p>
                                <h3 className="text-xl font-black text-orange-600">{formatCurrency(sumB29)}</h3>
                                <p className="text-[9px] font-bold text-slate-400 mt-2 italic">{sumP29 > 0 ? (sumB29/sumP29*100).toFixed(1) : 0}% Digunakan</p>
                            </div>
                        </div>

                        {/* Charts Section */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            
                            {/* Bar Chart - OS21 vs OS29 comparison */}
                            <div className="lg:col-span-2 bg-white p-8 rounded-[2.5rem] border border-slate-100 custom-shadow">
                                <h4 className="text-xs font-black text-slate-800 uppercase tracking-widest mb-8">Prestasi Kategori Mengikut Program (RM)</h4>
                                <div className="h-80 w-full">
                                    <ResponsiveContainer>
                                        <BarChart data={data}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                            <XAxis dataKey="kod" axisLine={false} tickLine={false} tick={{fontSize: 10, fontWeight: 800, fill: '#94a3b8'}} />
                                            <YAxis hide />
                                            <Tooltip 
                                                cursor={{fill: '#f8fafc'}}
                                                contentStyle={{borderRadius: '20px', border: 'none', boxShadow: '0 10px 15px rgba(0,0,0,0.1)'}}
                                                formatter={(val) => formatCurrency(val)}
                                            />
                                            <Legend iconType="circle" />
                                            <Bar dataKey="p21" name="Peruntukan OS21" fill="#3b82f6" radius={[4, 4, 0, 0]} />
                                            <Bar dataKey="b21" name="Belanja OS21" fill="#60a5fa" radius={[4, 4, 0, 0]} />
                                            <Bar dataKey="p29" name="Peruntukan OS29" fill="#8b5cf6" radius={[4, 4, 0, 0]} />
                                            <Bar dataKey="b29" name="Belanja OS29" fill="#a78bfa" radius={[4, 4, 0, 0]} />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>

                            {/* Pie Chart - Overall Distribution */}
                            <div className="bg-white p-8 rounded-[2.5rem] border border-slate-100 custom-shadow flex flex-col">
                                <h4 className="text-xs font-black text-slate-800 uppercase tracking-widest mb-4">Pecahan Peruntukan Kumpulan</h4>
                                <div className="flex-grow">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <PieChart>
                                            <Pie
                                                data={pieData}
                                                cx="50%" cy="50%"
                                                innerRadius={60}
                                                outerRadius={90}
                                                paddingAngle={5}
                                                dataKey="value"
                                            >
                                                {pieData.map((entry, index) => (
                                                    <Cell key={`cell-${index}`} fill={entry.color} />
                                                ))}
                                            </Pie>
                                            <Tooltip formatter={(val) => formatCurrency(val)} />
                                            <Legend verticalAlign="bottom" height={36}/>
                                        </PieChart>
                                    </ResponsiveContainer>
                                </div>
                                <div className="mt-4 p-4 bg-slate-50 rounded-2xl">
                                    <div className="flex justify-between items-center text-[10px] font-bold text-slate-500 uppercase">
                                        <span>OS21000 (Gaji/Elaun)</span>
                                        <span>{((sumP21/grandTotalP)*100).toFixed(1)}%</span>
                                    </div>
                                    <div className="flex justify-between items-center text-[10px] font-bold text-slate-500 uppercase mt-2">
                                        <span>OS29000 (Perkhidmatan)</span>
                                        <span>{((sumP29/grandTotalP)*100).toFixed(1)}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Table Section */}
                        <div className="bg-white rounded-[2.5rem] border border-slate-100 custom-shadow overflow-hidden">
                            <div className="p-8 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                                <h3 className="text-xs font-black text-slate-800 uppercase tracking-widest">Analisis Terperinci OS21 & OS29</h3>
                                <span className="text-[10px] font-black text-blue-600 bg-blue-50 px-3 py-1 rounded-full border border-blue-100">DOKUMEN ASAL: ANALISIS.CSV</span>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left text-xs border-collapse">
                                    <thead className="bg-slate-50 text-slate-400 font-black uppercase tracking-widest">
                                        <tr>
                                            <th className="p-5 border-b">Kod / Program</th>
                                            <th className="p-5 border-b text-center bg-blue-50/30">OS21 (P)</th>
                                            <th className="p-5 border-b text-center bg-blue-50/30">OS21 (B)</th>
                                            <th className="p-5 border-b text-center bg-purple-50/30">OS29 (P)</th>
                                            <th className="p-5 border-b text-center bg-purple-50/30">OS29 (B)</th>
                                            <th className="p-5 border-b text-right">Peratus Belanja</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-50 font-medium">
                                        {data.map((item, i) => (
                                            <tr key={i} className="hover:bg-slate-50/50 transition-colors">
                                                <td className="p-5">
                                                    <span className="font-black text-slate-800 block">{item.kod}</span>
                                                    <span className="text-[10px] text-slate-400">{item.program}</span>
                                                </td>
                                                <td className="p-5 text-center text-slate-600">{formatCurrency(item.p21)}</td>
                                                <td className="p-5 text-center text-orange-600">{formatCurrency(item.b21)}</td>
                                                <td className="p-5 text-center text-slate-600">{formatCurrency(item.p29)}</td>
                                                <td className="p-5 text-center text-orange-600">{formatCurrency(item.b29)}</td>
                                                <td className="p-5 text-right">
                                                    <div className="flex flex-col items-end">
                                                        <span className={`px-2 py-1 rounded-lg font-black text-[10px] ${parseFloat(item.peratus) > 80 ? 'bg-red-50 text-red-600' : 'bg-blue-50 text-blue-600'}`}>
                                                            {item.peratus}%
                                                        </span>
                                                        <div className="w-16 h-1 bg-slate-100 rounded-full mt-2 overflow-hidden">
                                                            <div className="h-full bg-blue-600" style={{width: `${item.peratus}%`}}></div>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                    <tfoot className="bg-slate-900 text-white font-black uppercase text-[10px] tracking-widest">
                                        <tr>
                                            <td className="p-5">JUMLAH BESAR (G)</td>
                                            <td className="p-5 text-center">{formatCurrency(sumP21)}</td>
                                            <td className="p-5 text-center text-orange-400">{formatCurrency(sumB21)}</td>
                                            <td className="p-5 text-center">{formatCurrency(sumP29)}</td>
                                            <td className="p-5 text-center text-orange-400">{formatCurrency(sumB29)}</td>
                                            <td className="p-5 text-right text-xl">{peratusKeseluruhan.toFixed(1)}%</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div className="mt-20 text-center opacity-30">
                        <p className="text-[9px] font-black uppercase tracking-[0.5em] italic italic">IAB KPM FINANCIAL ANALYTICS v4.0</p>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

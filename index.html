<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Analisis Kewangan LDP 2026</title>
    
    <!-- Panggilan Library Luaran -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .card-glow:hover { box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.1), 0 10px 10px -5px rgba(59, 130, 246, 0.04); }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="fallback-ui" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50">
        <div class="w-12 h-12 border-4 border-slate-100 border-t-blue-600 rounded-full spin mb-4"></div>
        <h2 class="text-slate-800 font-bold tracking-tight">Menjana Dashboard...</h2>
        <p class="text-slate-400 text-xs mt-2 italic">Menyemak sambungan data...</p>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { 
            BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, 
            ResponsiveContainer, Cell, PieChart, Pie, ComposedChart, Line
        } = Recharts;

        // =================================================================================
        // ðŸ”§ KONFIGURASI LINK GOOGLE SHEET (LIVE CSV)
        // =================================================================================
        const SHEET_LINKS = {
            ANALISIS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZd2KLh_LqBhHbSkRKL0rsoESf60kgFSomuC8kwgZqkLbRvXyqWTqr2DoEzzP15BV491auFw3BdFKd/pub?gid=0&single=true&output=csv', 
            PROGRAMS: {
                'LDP-BPG-LEAD AUDITOR': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZd2KLh_LqBhHbSkRKL0rsoESf60kgFSomuC8kwgZqkLbRvXyqWTqr2DoEzzP15BV491auFw3BdFKd/pub?gid=1435925801&single=true&output=csv',
                'LDP-BPG-PEMERKASAAN COE': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZd2KLh_LqBhHbSkRKL0rsoESf60kgFSomuC8kwgZqkLbRvXyqWTqr2DoEzzP15BV491auFw3BdFKd/pub?gid=1031215483&single=true&output=csv',
                'LDP-BPG-CERTIFIED ASSESSOR': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZd2KLh_LqBhHbSkRKL0rsoESf60kgFSomuC8kwgZqkLbRvXyqWTqr2DoEzzP15BV491auFw3BdFKd/pub?gid=2077989648&single=true&output=csv'
            }
        };

        // DATA CONTOH (BACKUP) - Akan muncul jika sambungan LIVE gagal
        const MOCK_DATA = [
            { kod: 'SK145', program: 'LDP-BPG-LEAD AUDITOR', p21: 0, p29: 0, b21: 0, b29: 0, peruntukan: 0, belanja: 0, baki: 0, peratus: 0 },
            { kod: 'SK146', program: 'LDP-BPG-PEMERKASAAN COE', p21: 30000, p29: 12600, b21: 0, b29: 0, peruntukan: 42600, belanja: 0, baki: 42600, peratus: 0 },
            { kod: 'SK147', program: 'LDP-BPG-CERTIFIED ASSESSOR', p21: 7000, p29: 2400, b21: 7000, b29: 2400, peruntukan: 9400, belanja: 9400, baki: 0, peratus: 100 }
        ];

        const formatCurrency = (val) => new Intl.NumberFormat('ms-MY', { style: 'currency', currency: 'MYR' }).format(val);

        const cleanNum = (str) => {
            if (!str || typeof str !== 'string') return 0;
            let cleaned = str.replace(/[RM,\s%"$]/g, "").trim();
            if (cleaned === "#DIV/0!" || cleaned === "" || isNaN(cleaned)) return 0;
            return parseFloat(cleaned);
        };

        const robustSplit = (line) => {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
                else current += char;
            }
            result.push(current.trim());
            return result;
        };

        function App() {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isLive, setIsLive] = useState(false);
            const [lastUpdated, setLastUpdated] = useState("");

            useEffect(() => {
                const fb = document.getElementById('fallback-ui');
                if (fb) fb.style.display = 'none';
                fetchSummary();
            }, []);

            const fetchSummary = async () => {
                setLoading(true);
                try {
                    // Cuba ambil data Live dulu
                    const response = await fetch(SHEET_LINKS.ANALISIS);
                    if (!response.ok) throw new Error("Gagal");
                    
                    const text = await response.text();
                    if (text.startsWith("<!DOCTYPE html>")) throw new Error("HTML response");

                    const lines = text.split(/\r?\n/).filter(l => l.trim());
                    const parsed = [];
                    
                    lines.forEach((line) => {
                        const row = robustSplit(line);
                        // Data dalam ANALISIS.csv bermula dengan SK di index 1
                        if (row.length > 8 && row[1] && row[1].startsWith('SK')) {
                            const p21 = cleanNum(row[3]);
                            const p29 = cleanNum(row[4]);
                            const b21 = cleanNum(row[6]);
                            const b29 = cleanNum(row[7]);
                            const totalP = p21 + p29;
                            const totalB = b21 + b29;
                            // Kira peratus manual jika data excel #DIV/0!
                            const peratus = totalP > 0 ? (totalB / totalP) * 100 : 0;

                            parsed.push({
                                kod: row[1],
                                program: row[2].replace(/"/g, ''),
                                p21, p29, b21, b29,
                                peruntukan: totalP,
                                belanja: totalB,
                                baki: totalP - totalB,
                                peratus: parseFloat(peratus.toFixed(2))
                            });
                        }
                    });

                    if (parsed.length === 0) throw new Error("Tiada data SK ditemui");
                    
                    setData(parsed);
                    setIsLive(true);
                    setLastUpdated(new Date().toLocaleTimeString());
                } catch (err) {
                    // Jika gagal (CORS atau link salah), guna MOCK_DATA
                    console.warn("Gagal sambung Live Data, menggunakan data contoh.", err);
                    setData(MOCK_DATA);
                    setIsLive(false); // Mode Backup
                    setLastUpdated("Mode Pratonton (Offline)");
                }
                setLoading(false);
            };

            // Rumusan Kategori
            const sumP21 = data.reduce((a, b) => a + b.p21, 0);
            const sumP29 = data.reduce((a, b) => a + b.p29, 0);
            const sumB21 = data.reduce((a, b) => a + b.b21, 0);
            const sumB29 = data.reduce((a, b) => a + b.b29, 0);
            const grandTotalP = sumP21 + sumP29;
            const grandTotalB = sumB21 + sumB29;
            const globalPeratus = grandTotalP > 0 ? (grandTotalB / grandTotalP) * 100 : 0;

            const pieData = [
                { name: 'OS21000', value: sumP21, color: '#2563eb' },
                { name: 'OS29000', value: sumP29, color: '#9333ea' }
            ];

            return (
                <div className="min-h-screen pb-20 fade-in">
                    {/* Top Bar */}
                    <div className="bg-white/80 backdrop-blur-md border-b sticky top-0 z-40 px-6 py-4 flex flex-col md:flex-row justify-between items-center gap-4 shadow-sm">
                        <div className="flex items-center gap-3">
                            <div className={`p-2 rounded-xl text-white shadow-lg ${isLive ? 'bg-emerald-500 shadow-emerald-200' : 'bg-orange-500 shadow-orange-200'}`}>
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>
                            </div>
                            <div>
                                <h1 className="text-lg font-black text-slate-900 leading-none uppercase tracking-tighter">Analisis Kewangan LDP 2026</h1>
                                <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">
                                    Status: <span className={`${isLive ? 'text-emerald-600' : 'text-orange-500'} italic font-bold`}>
                                        {isLive ? 'LIVE (Google Sheets)' : 'Mod Pratonton (Data Contoh)'}
                                    </span>
                                </p>
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="text-right hidden md:block">
                                <p className="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Kemas kini terakhir</p>
                                <p className="text-xs font-black text-slate-700">{lastUpdated}</p>
                            </div>
                            <button onClick={fetchSummary} className="bg-slate-900 text-white px-6 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-black transition-all shadow-md active:scale-95">
                                {loading ? 'Memuatkan...' : 'Segarkan'}
                            </button>
                        </div>
                    </div>

                    {!isLive && (
                        <div className="bg-orange-50 border-b border-orange-100 p-2 text-center text-[10px] font-bold text-orange-600 uppercase tracking-widest">
                            Nota: Paparan ini menggunakan data contoh kerana sambungan Live disekat di dalam preview ini. Di GitHub nanti ia akan jadi Live.
                        </div>
                    )}

                    <div className="max-w-7xl mx-auto p-6 lg:p-10 space-y-10 animate-in fade-in slide-in-from-bottom-4 duration-500">
                        
                        {/* Summary Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div className="bg-white p-6 rounded-[2rem] border border-slate-100 card-glow transition-all">
                                <p className="text-[10px] text-slate-400 font-black uppercase tracking-[0.2em] mb-1">Peruntukan OS21000</p>
                                <h2 className="text-2xl font-black text-slate-800 tracking-tighter">{formatCurrency(sumP21)}</h2>
                                <div className="mt-4 flex items-center justify-between text-[10px] font-bold text-slate-400">
                                    <span>PENGGUNAAN</span>
                                    <span className="text-blue-600">{sumP21 > 0 ? (sumB21/sumP21*100).toFixed(1) : 0}%</span>
                                </div>
                                <div className="mt-2 h-1.5 w-full bg-slate-50 rounded-full overflow-hidden">
                                    <div className="h-full bg-blue-500 transition-all duration-1000" style={{width: `${sumP21 > 0 ? (sumB21/sumP21*100) : 0}%`}}></div>
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-[2rem] border border-slate-100 card-glow transition-all">
                                <p className="text-[10px] text-slate-400 font-black uppercase tracking-[0.2em] mb-1">Peruntukan OS29000</p>
                                <h2 className="text-2xl font-black text-slate-800 tracking-tighter">{formatCurrency(sumP29)}</h2>
                                <div className="mt-4 flex items-center justify-between text-[10px] font-bold text-slate-400">
                                    <span>PENGGUNAAN</span>
                                    <span className="text-purple-600">{sumP29 > 0 ? (sumB29/sumP29*100).toFixed(1) : 0}%</span>
                                </div>
                                <div className="mt-2 h-1.5 w-full bg-slate-50 rounded-full overflow-hidden">
                                    <div className="h-full bg-purple-500 transition-all duration-1000" style={{width: `${sumP29 > 0 ? (sumB29/sumP29*100) : 0}%`}}></div>
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-[2rem] border border-slate-100 card-glow transition-all bg-gradient-to-br from-white to-orange-50/30">
                                <p className="text-[10px] text-slate-400 font-black uppercase tracking-[0.2em] mb-1">Belanja Keseluruhan</p>
                                <h2 className="text-2xl font-black text-orange-600 tracking-tighter">{formatCurrency(grandTotalB)}</h2>
                                <p className="text-[10px] text-orange-400 font-bold mt-2 uppercase tracking-tighter italic">Prestasi: {globalPeratus > 80 ? 'TINGGI' : 'OPTIMAL'}</p>
                            </div>
                            <div className="bg-slate-900 p-6 rounded-[2rem] text-white shadow-2xl shadow-slate-200">
                                <p className="text-[10px] text-slate-500 font-black uppercase tracking-[0.2em] mb-1">Baki Semasa</p>
                                <h2 className="text-2xl font-black tracking-tighter">{formatCurrency(grandTotalP - grandTotalB)}</h2>
                                <div className="mt-4 flex justify-between items-center">
                                    <span className="text-[10px] font-black text-blue-400">PENGGUNAAN DANA</span>
                                    <span className="text-lg font-black">{globalPeratus.toFixed(1)}%</span>
                                </div>
                            </div>
                        </div>

                        {/* Main Charts */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            {/* Bar Chart Section */}
                            <div className="lg:col-span-2 bg-white p-8 rounded-[3rem] border border-slate-100 shadow-sm">
                                <div className="flex justify-between items-center mb-10">
                                    <div>
                                        <h3 className="text-sm font-black text-slate-800 uppercase tracking-widest">Prestasi Mengikut Modul</h3>
                                        <p className="text-[10px] text-slate-400 font-bold">Analisis OS21000 vs OS29000 (RM)</p>
                                    </div>
                                    <div className="flex gap-4">
                                        <div className="flex items-center gap-2"><div className="w-2 h-2 bg-blue-500 rounded-full"></div><span className="text-[9px] font-bold text-slate-500">OS21</span></div>
                                        <div className="flex items-center gap-2"><div className="w-2 h-2 bg-purple-500 rounded-full"></div><span className="text-[9px] font-bold text-slate-500">OS29</span></div>
                                    </div>
                                </div>
                                <div className="h-80 w-full">
                                    <ResponsiveContainer>
                                        <ComposedChart data={data}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                            <XAxis dataKey="kod" axisLine={false} tickLine={false} tick={{fontSize: 10, fontWeight: 800, fill: '#94a3b8'}} />
                                            <YAxis hide />
                                            <Tooltip 
                                                cursor={{fill: '#f8fafc'}}
                                                contentStyle={{borderRadius: '24px', border: 'none', boxShadow: '0 20px 25px -5px rgba(0,0,0,0.1)'}}
                                                formatter={(val) => formatCurrency(val)}
                                            />
                                            <Bar dataKey="p21" name="Peruntukan OS21" fill="#3b82f6" radius={[4, 4, 0, 0]} barSize={20} />
                                            <Bar dataKey="p29" name="Peruntukan OS29" fill="#a855f7" radius={[4, 4, 0, 0]} barSize={20} />
                                            <Line type="monotone" dataKey="peratus" name="Peratus Guna (%)" stroke="#f97316" strokeWidth={3} dot={{r: 4}} />
                                        </ComposedChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>

                            {/* Pie Chart Section */}
                            <div className="bg-white p-8 rounded-[3rem] border border-slate-100 shadow-sm flex flex-col">
                                <h3 className="text-sm font-black text-slate-800 uppercase tracking-widest mb-6">Pecahan Peruntukan</h3>
                                <div className="flex-grow min-h-[300px]">
                                    <ResponsiveContainer>
                                        <PieChart>
                                            <Pie
                                                data={pieData}
                                                cx="50%" cy="50%"
                                                innerRadius={65}
                                                outerRadius={95}
                                                paddingAngle={8}
                                                dataKey="value"
                                                stroke="none"
                                            >
                                                {pieData.map((entry, index) => (
                                                    <Cell key={`cell-${index}`} fill={entry.color} />
                                                ))}
                                            </Pie>
                                            <Tooltip formatter={(val) => formatCurrency(val)} />
                                            <Legend verticalAlign="bottom" align="center" iconType="circle" wrapperStyle={{paddingTop: '20px', fontSize: '10px', fontWeight: 'bold'}} />
                                        </PieChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        </div>

                        {/* Detailed Table */}
                        <div className="bg-white rounded-[3rem] border border-slate-100 shadow-sm overflow-hidden">
                            <div className="p-8 border-b bg-slate-50/50 flex justify-between items-center">
                                <h3 className="text-sm font-black text-slate-800 uppercase tracking-widest">Analisis Terperinci OS21 & OS29</h3>
                                <div className="flex items-center gap-2">
                                    <span className="text-[10px] font-black text-slate-400 uppercase">JUMLAH REKOD:</span>
                                    <span className="bg-blue-600 text-white w-6 h-6 flex items-center justify-center rounded-full text-[10px] font-bold">{data.length}</span>
                                </div>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left text-xs border-collapse">
                                    <thead>
                                        <tr className="bg-slate-50/80 text-slate-400 font-black uppercase tracking-widest text-[9px] border-b">
                                            <th className="p-6">Kod & Program</th>
                                            <th className="p-6 text-center border-l bg-blue-50/20">OS21000 (P)</th>
                                            <th className="p-6 text-center bg-blue-50/20">OS21000 (B)</th>
                                            <th className="p-6 text-center border-l bg-purple-50/20">OS29000 (P)</th>
                                            <th className="p-6 text-center bg-purple-50/20">OS29000 (B)</th>
                                            <th className="p-6 text-right border-l">Baki (RM)</th>
                                            <th className="p-6 text-right">% Belanja</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-50 font-medium text-slate-600">
                                        {data.map((item, i) => (
                                            <tr key={i} className="hover:bg-slate-50/50 transition-colors group">
                                                <td className="p-6">
                                                    <span className="font-black text-slate-900 block group-hover:text-blue-600 transition-colors">{item.kod}</span>
                                                    <span className="text-[10px] text-slate-400 font-bold leading-tight">{item.program}</span>
                                                </td>
                                                <td className="p-6 text-center bg-blue-50/5">{formatCurrency(item.p21)}</td>
                                                <td className="p-6 text-center font-bold text-blue-600 bg-blue-50/5">{formatCurrency(item.b21)}</td>
                                                <td className="p-6 text-center bg-purple-50/5">{formatCurrency(item.p29)}</td>
                                                <td className="p-6 text-center font-bold text-purple-600 bg-purple-50/5">{formatCurrency(item.b29)}</td>
                                                <td className="p-6 text-right font-black text-slate-800">{formatCurrency(item.baki)}</td>
                                                <td className="p-6 text-right">
                                                    <div className="flex flex-col items-end">
                                                        <span className={`text-[11px] font-black px-3 py-1 rounded-lg ${item.peratus > 90 ? 'bg-red-100 text-red-600' : 'bg-emerald-100 text-emerald-600'}`}>
                                                            {item.peratus}%
                                                        </span>
                                                        <div className="w-16 h-1.5 bg-slate-100 rounded-full mt-2 overflow-hidden">
                                                            <div className={`h-full ${item.peratus > 90 ? 'bg-red-500' : 'bg-emerald-500'}`} style={{width: `${item.peratus}%`}}></div>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                    <tfoot className="bg-slate-900 text-white">
                                        <tr className="font-black uppercase tracking-tighter text-sm">
                                            <td className="p-8">Jumlah Keseluruhan</td>
                                            <td className="p-8 text-center">{formatCurrency(sumP21)}</td>
                                            <td className="p-8 text-center text-blue-400">{formatCurrency(sumB21)}</td>
                                            <td className="p-8 text-center">{formatCurrency(sumP29)}</td>
                                            <td className="p-8 text-center text-purple-400">{formatCurrency(sumB29)}</td>
                                            <td className="p-8 text-right text-emerald-400">{formatCurrency(grandTotalP - grandTotalB)}</td>
                                            <td className="p-8 text-right text-2xl">{globalPeratus.toFixed(1)}%</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>

                    <footer className="mt-20 py-10 text-center border-t border-slate-200">
                        <p className="text-[9px] font-black text-slate-300 uppercase tracking-[0.5em] italic italic">IAB KPM FINANCIAL ANALYTICS v5.0 â€¢ REAL-TIME DATA</p>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
